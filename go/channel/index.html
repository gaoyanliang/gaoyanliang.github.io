<!DOCTYPE html>
<html lang='en'>

<head>
  <meta name="generator" content="Hexo 5.4.0">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.18.5">
  <meta charset="utf-8">
  

  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://gcore.jsdelivr.net'>
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin>
  <link rel='dns-prefetch' href='//unpkg.com'>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  <title>Go,channel,chan</title>

  
    <meta name="description" content="æœ¬æ–‡ä¸»è¦ä»‹ç»äº† Go è¯­è¨€ (golang) ä¸­çš„ channelï¼Œå¹¶ä»æºç å±‚é¢åˆ†æå…¶å…·ä½“å®ç°ï¼ŒåŒ…æ‹¬åˆ›å»º channelï¼Œå‘é€æ•°æ®ï¼Œæ¥æ”¶æ•°æ®ä»¥åŠç›¸å…³è°ƒåº¦ç­‰ã€‚  ä»¥ä¸‹åˆ†æåŸºäº Go 1.17.5  1. æ¦‚è¿°å®˜æ–¹å¯¹ chan çš„æè¿°å¦‚ä¸‹ï¼š  A channel provides a mechanism for concurrently executing functions to communica">
<meta property="og:type" content="article">
<meta property="og:title" content="Go ç³»åˆ—(ä¸€)ï¼šchan æºç åˆ†æ">
<meta property="og:url" content="https://yanliang.cool/go/channel/">
<meta property="og:site_name" content="yanliang">
<meta property="og:description" content="æœ¬æ–‡ä¸»è¦ä»‹ç»äº† Go è¯­è¨€ (golang) ä¸­çš„ channelï¼Œå¹¶ä»æºç å±‚é¢åˆ†æå…¶å…·ä½“å®ç°ï¼ŒåŒ…æ‹¬åˆ›å»º channelï¼Œå‘é€æ•°æ®ï¼Œæ¥æ”¶æ•°æ®ä»¥åŠç›¸å…³è°ƒåº¦ç­‰ã€‚  ä»¥ä¸‹åˆ†æåŸºäº Go 1.17.5  1. æ¦‚è¿°å®˜æ–¹å¯¹ chan çš„æè¿°å¦‚ä¸‹ï¼š  A channel provides a mechanism for concurrently executing functions to communica">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/post/go/go1.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/post/go/go2.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/post/go/go3.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/post/go/go4.png">
<meta property="article:published_time" content="2022-10-02T00:00:00.000Z">
<meta property="article:modified_time" content="2022-10-02T00:00:00.000Z">
<meta property="article:author" content="yanliang">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="chan">
<meta property="article:tag" content="channel">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/post/go/go1.png">
  
  

  <!-- feed -->
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  
    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/icon.svg">
  

  

  


  
</head>

<body>
  


  <div class='l_body' id='start'>
    <aside class='l_left' layout='post'>
    

  

<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/index-head.png" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title"><div style="line-height: 1.5; letter-spacing: 3px; position: relative;">Yanliang</div> <div style="font-size: .85rem; letter-spacing: 1px; font-weight: 500;">Believe in yourself.</div></div></a></div>

<nav class="menu dis-select"><a class="nav-item active" href="/">Blog</a><a class="nav-item" href="/wiki/">Wiki</a><a class="nav-item" href="/friends/">Friends</a><a class="nav-item" href="/about/">More</a></nav></header>


<div class="widgets">
<widget class="widget-wrapper search"><div class="widget-body"><div class="search-wrapper" id="search"><form class="search-form"><input type="text" class="search-input" id="search-input" placeholder="Search"><svg t="1670596976048" class="icon search-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2676" width="200" height="200"><path d="M938.2 832.6L723.8 618.1c-2.5-2.5-5.3-4.4-7.9-6.4 36.2-55.6 57.3-121.8 57.3-193.1C773.3 222.8 614.6 64 418.7 64S64 222.8 64 418.6c0 195.9 158.8 354.6 354.6 354.6 71.3 0 137.5-21.2 193.2-57.4 2 2.7 3.9 5.4 6.3 7.8L832.5 938c14.6 14.6 33.7 21.9 52.8 21.9 19.1 0 38.2-7.3 52.8-21.8 29.2-29.1 29.2-76.4 0.1-105.5M418.7 661.3C284.9 661.3 176 552.4 176 418.6 176 284.9 284.9 176 418.7 176c133.8 0 242.6 108.9 242.6 242.7 0 133.7-108.9 242.6-242.6 242.6" p-id="2677"></path></svg></form><div id="search-result"></div><div class="search-no-result">No Results!</div></div></div></widget>

<widget class="widget-wrapper toc single" id="data-toc"><div class="widget-header cap dis-select"><span class="name">Go ç³»åˆ—(ä¸€)ï¼šchan æºç åˆ†æ</span></div><div class="widget-body fs14"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-text">2. æ•°æ®ç»“æ„</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">3. å®ç°åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%88%9B%E5%BB%BA-chan"><span class="toc-text">3.1 åˆ›å»º chan</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE"><span class="toc-text">3.2 å‘é€æ•°æ®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE"><span class="toc-text">3.3 æ¥æ”¶æ•°æ®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%85%B3%E9%97%AD-chan"><span class="toc-text">3.4 å…³é—­ chan</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%BF%9B%E9%98%B6"><span class="toc-text">4. è¿›é˜¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E6%93%8D%E4%BD%9C-chan"><span class="toc-text">4.1 æ“ä½œ chan</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%8F%91%E9%80%81%E5%92%8C%E6%8E%A5%E6%94%B6%E5%85%83%E7%B4%A0%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="toc-text">4.2 å‘é€å’Œæ¥æ”¶å…ƒç´ çš„æœ¬è´¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E8%B5%84%E6%BA%90%E6%B3%84%E6%BC%8F"><span class="toc-text">4.3 èµ„æºæ³„æ¼</span></a></li></ol></li></ol></div></div></widget>


</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" title="Back to Top" href="#start" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/social/top.svg"/></a><a class="social" title="GitHub" href="https://github.com/gyl-coder/" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/social/github.svg"/></a><a class="social" title="Spotify" href="https://open.spotify.com/" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/social/music.svg"/></a><a class="social" title="Unsplash" href="https://unsplash.com/" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/social/music.svg"/></a><a class="social" title="Comments" href="/about/#comments" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/social/message.svg"/></a></div></footer>

    </aside>
    <div class='l_main'>
      

      


<div class="bread-nav fs12"><div id="breadcrumb"><a class="cap breadcrumb" href="/">Home</a><span class="sep"></span><a class="cap breadcrumb" href="/">Blog</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/go/">Go</a></div><div id="post-meta">ğŸ’§ Posted on&nbsp;<time datetime="2022-10-02T00:00:00.000Z">Oct 2, 2022</time></div></div>

<article class='md-text content post'>
<h1 class="article-title"><span>Go ç³»åˆ—(ä¸€)ï¼šchan æºç åˆ†æ</span></h1>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº† Go è¯­è¨€ (golang) ä¸­çš„ channelï¼Œå¹¶ä»æºç å±‚é¢åˆ†æå…¶å…·ä½“å®ç°ï¼ŒåŒ…æ‹¬åˆ›å»º channelï¼Œå‘é€æ•°æ®ï¼Œæ¥æ”¶æ•°æ®ä»¥åŠç›¸å…³è°ƒåº¦ç­‰ã€‚</p>
<blockquote>
<p>ä»¥ä¸‹åˆ†æåŸºäº Go 1.17.5</p>
</blockquote>
<h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h2><p>å®˜æ–¹å¯¹ chan çš„æè¿°å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>A channel provides a mechanism for concurrently executing functions to communicate by sending and receivingvalues of a specified element type. The value of an uninitialized channel is nil.</p>
</blockquote>
<p>chan æä¾›äº†ä¸€ç§å¹¶å‘é€šä¿¡æœºåˆ¶ï¼Œç”¨äºç”Ÿäº§å’Œæ¶ˆè´¹æŸä¸€æŒ‡å®šç±»å‹æ•°æ®ï¼Œæœªåˆå§‹åŒ–çš„ chan çš„å€¼æ˜¯ nilã€‚</p>
<p>Chan æ˜¯ Go é‡Œé¢çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>goroutine-safeï¼Œå¤šä¸ª goroutine å¯ä»¥åŒæ—¶è®¿é—®ä¸€ä¸ª channel è€Œä¸ä¼šå‡ºç°å¹¶å‘é—®é¢˜<ul>
<li>hchan <strong>mutex</strong>ï¼Œé€šè¿‡åŠ é”æ¥é¿å…æ•°æ®ç«äº‰ã€‚</li>
</ul>
</li>
<li>å¯ä»¥ç”¨äºåœ¨ goroutine ä¹‹é—´å­˜å‚¨å’Œä¼ é€’å€¼<ul>
<li>copying into and out of hchan <strong>buffer</strong></li>
</ul>
</li>
<li>å…¶è¯­ä¹‰æ˜¯å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰</li>
<li>å¯ä»¥å¯¼è‡´ goroutine çš„ block å’Œ unblock<ul>
<li>é€šè¿‡ <strong>sudog queues</strong> æ¥è®°å½•é˜»å¡çš„ goroutineã€‚</li>
<li>é€šè¿‡ <strong>runtime scheduler</strong>(gopark, goready) æ¥å®ç°é˜»å¡ä¸å”¤é†’ã€‚</li>
</ul>
</li>
</ul>
<p>Channel å­—é¢æ„ä¹‰æ˜¯â€œé€šé“â€ï¼Œç±»ä¼¼äº Linux ä¸­çš„ç®¡é“ã€‚å£°æ˜ channel çš„è¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">chan</span> T <span class="comment">// å£°æ˜ä¸€ä¸ªåŒå‘é€šé“</span></span><br><span class="line"><span class="keyword">chan</span>&lt;- T <span class="comment">// å£°æ˜ä¸€ä¸ªåªèƒ½ç”¨äºå‘é€çš„é€šé“</span></span><br><span class="line">&lt;-<span class="keyword">chan</span> T <span class="comment">// å£°æ˜ä¸€ä¸ªåªèƒ½ç”¨äºæ¥æ”¶çš„é€šé“</span></span><br></pre></td></tr></table></figure>

<p>å•å‘é€šé“çš„å£°æ˜ï¼Œç”¨ &lt;- æ¥è¡¨ç¤ºï¼Œå®ƒæŒ‡æ˜é€šé“çš„æ–¹å‘ã€‚</p>
<p>å› ä¸º channel æ˜¯ä¸€ä¸ªå¼•ç”¨ç±»å‹ï¼Œæ‰€ä»¥åœ¨å®ƒè¢«åˆå§‹åŒ–ä¹‹å‰ï¼Œå®ƒçš„å€¼æ˜¯ nilï¼Œchannel ä½¿ç”¨ make å‡½æ•°è¿›è¡Œåˆå§‹åŒ–ã€‚å¯ä»¥å‘å®ƒä¼ é€’ä¸€ä¸ª int å€¼ï¼Œä»£è¡¨ channel ç¼“å†²åŒºçš„å¤§å°ï¼ˆå®¹é‡ï¼‰ï¼Œæ„é€ å‡ºæ¥çš„æ˜¯ä¸€ä¸ªç¼“å†²å‹çš„ channelï¼›ä¸ä¼ æˆ–ä¼  0 çš„ï¼Œæ„é€ çš„å°±æ˜¯ä¸€ä¸ªéç¼“å†²å‹çš„ channelã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ— ç¼“å†²</span></span><br><span class="line">ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼“å†²åŒºä¸º 3</span></span><br><span class="line">ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p><strong>chanï¼ˆå³ hchan ç»“æ„ä½“ï¼‰ é»˜è®¤ä¼šè¢«åˆ†é…åœ¨å †ä¸Šï¼Œmake è¿”å›çš„åªæ˜¯ä¸€ä¸ªæŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆ</strong>ã€‚</p>
<p><strong>æ— ç¼“å†² channel</strong></p>
<p>æ— ç¼“å†²çš„ channelï¼ˆunbuffered channelï¼‰ï¼Œå…¶ç¼“å†²åŒºå¤§å°åˆ™é»˜è®¤ä¸º 0ã€‚åœ¨åŠŸèƒ½ä¸Šå…¶æ¥å—è€…ä¼šé˜»å¡ç­‰å¾…å¹¶é˜»å¡åº”ç”¨ç¨‹åºï¼Œç›´è‡³æ”¶åˆ°é€šä¿¡å’Œæ¥æ”¶åˆ°æ•°æ®ã€‚</p>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/post/go/go1.png" fancybox="true"/></div></div>

<p>ï¼ˆå¼•ç”¨ William Kennedy çš„å›¾ï¼‰</p>
<p><strong>ç¼“å†² channel</strong></p>
<p>æœ‰ç¼“å­˜çš„ channelï¼ˆbuffered channelï¼‰ï¼Œå…¶ç¼“å­˜åŒºå¤§å°æ˜¯æ ¹æ®æ‰€è®¾ç½®çš„å€¼æ¥è°ƒæ•´ã€‚åœ¨åŠŸèƒ½ä¸Šï¼Œè‹¥ç¼“å†²åŒºæœªæ»¡åˆ™ä¸ä¼šé˜»å¡ï¼Œä¼šæºæºä¸æ–­çš„è¿›è¡Œä¼ è¾“ã€‚å½“ç¼“å†²åŒºæ»¡äº†åï¼Œå‘é€è€…å°±ä¼šé˜»å¡å¹¶ç­‰å¾…ã€‚è€Œå½“ç¼“å†²åŒºä¸ºç©ºæ—¶ï¼Œæ¥å—è€…å°±ä¼šé˜»å¡å¹¶ç­‰å¾…ï¼Œç›´è‡³æœ‰æ–°çš„æ•°æ®ï¼š</p>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/post/go/go2.png" fancybox="true"/></div></div>

<p>ï¼ˆå¼•ç”¨ William Kennedy çš„å›¾ï¼‰</p>
<h2 id="2-æ•°æ®ç»“æ„"><a href="#2-æ•°æ®ç»“æ„" class="headerlink" title="2. æ•°æ®ç»“æ„"></a>2. æ•°æ®ç»“æ„</h2><p>æœ¬è´¨ä¸Š channel åœ¨è®¾è®¡ä¸Šå°±æ˜¯ç¯å½¢é˜Ÿåˆ—ã€‚å…¶åŒ…å«å‘é€æ–¹é˜Ÿåˆ—ã€æ¥æ”¶æ–¹é˜Ÿåˆ—ï¼ŒåŠ ä¸Šäº’æ–¥é” mutex ç­‰ç»“æ„ã€‚</p>
<p>channel æ˜¯ä¸€ä¸ªæœ‰é”çš„ç¯å½¢é˜Ÿåˆ—ï¼š</p>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/post/go/go3.png" fancybox="true"/></div></div>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/runtime/chan.go</span></span><br><span class="line"><span class="keyword">type</span> hchan <span class="keyword">struct</span> &#123;</span><br><span class="line">    closed   <span class="keyword">uint32</span>   <span class="comment">// channelæ˜¯å¦å…³é—­çš„æ ‡å¿—</span></span><br><span class="line">    elemtype *_type   <span class="comment">// channelä¸­çš„å…ƒç´ ç±»å‹</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// channelåˆ†ä¸ºæ— ç¼“å†²å’Œæœ‰ç¼“å†²ä¸¤ç§ã€‚</span></span><br><span class="line">    <span class="comment">// å¯¹äºæœ‰ç¼“å†²çš„channelå­˜å‚¨æ•°æ®ï¼Œä½¿ç”¨äº† ring bufferï¼ˆç¯å½¢ç¼“å†²åŒº) æ¥ç¼“å­˜å†™å…¥çš„æ•°æ®ï¼Œæœ¬è´¨æ˜¯å¾ªç¯æ•°ç»„</span></span><br><span class="line">    <span class="comment">// ä¸ºå•¥æ˜¯å¾ªç¯æ•°ç»„ï¼Ÿæ™®é€šæ•°ç»„ä¸è¡Œå—ï¼Œæ™®é€šæ•°ç»„å®¹é‡å›ºå®šæ›´é€‚åˆæŒ‡å®šçš„ç©ºé—´ï¼Œå¼¹å‡ºå…ƒç´ æ—¶ï¼Œæ™®é€šæ•°ç»„éœ€è¦å…¨éƒ¨éƒ½å‰ç§»</span></span><br><span class="line">    <span class="comment">// å½“ä¸‹æ ‡è¶…è¿‡æ•°ç»„å®¹é‡åä¼šå›åˆ°ç¬¬ä¸€ä¸ªä½ç½®ï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸¤ä¸ªå­—æ®µè®°å½•å½“å‰è¯»å’Œå†™çš„ä¸‹æ ‡ä½ç½®</span></span><br><span class="line">    buf      unsafe.Pointer <span class="comment">// æŒ‡å‘åº•å±‚å¾ªç¯æ•°ç»„çš„æŒ‡é’ˆï¼ˆç¯å½¢ç¼“å†²åŒºï¼‰</span></span><br><span class="line">    qcount   <span class="keyword">uint</span>           <span class="comment">// å¾ªç¯æ•°ç»„ä¸­çš„å…ƒç´ æ•°é‡</span></span><br><span class="line">    dataqsiz <span class="keyword">uint</span>           <span class="comment">// å¾ªç¯æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">    elemsize <span class="keyword">uint16</span>                 <span class="comment">// å…ƒç´ çš„å¤§å°</span></span><br><span class="line">    sendx    <span class="keyword">uint</span>           <span class="comment">// ä¸‹ä¸€æ¬¡å†™ä¸‹æ ‡çš„ä½ç½®</span></span><br><span class="line">    recvx    <span class="keyword">uint</span>           <span class="comment">// ä¸‹ä¸€æ¬¡è¯»ä¸‹æ ‡çš„ä½ç½®</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°è¯•è¯»å–channelæˆ–å‘channelå†™å…¥æ•°æ®è€Œè¢«é˜»å¡çš„goroutine</span></span><br><span class="line">    recvq    waitq  <span class="comment">// è¯»ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    sendq    waitq  <span class="comment">// å†™ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">  </span><br><span class="line">    lock mutex <span class="comment">//äº’æ–¥é”ï¼Œä¿è¯è¯»å†™channelæ—¶ä¸å­˜åœ¨å¹¶å‘ç«äº‰é—®é¢˜</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> waitq <span class="keyword">struct</span> &#123;</span><br><span class="line">    first *sudog</span><br><span class="line">    last  *sudog</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> sudog <span class="keyword">struct</span> &#123;</span><br><span class="line">    g *g   <span class="comment">// æŒ‡å‘å½“å‰çš„ goroutineã€‚</span></span><br><span class="line">    next *sudog  <span class="comment">// æŒ‡å‘ä¸‹ä¸€ä¸ª gã€‚</span></span><br><span class="line">    prev *sudog  <span class="comment">// æŒ‡å‘ä¸Šä¸€ä¸ª gã€‚</span></span><br><span class="line">    elem unsafe.Pointer  <span class="comment">// æ•°æ®å…ƒç´ ï¼Œå¯èƒ½ä¼šæŒ‡å‘å †æ ˆã€‚</span></span><br><span class="line">    c        *hchan</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-å®ç°åŸç†"><a href="#3-å®ç°åŸç†" class="headerlink" title="3. å®ç°åŸç†"></a>3. å®ç°åŸç†</h2><h3 id="3-1-åˆ›å»º-chan"><a href="#3-1-åˆ›å»º-chan" class="headerlink" title="3.1 åˆ›å»º chan"></a>3.1 åˆ›å»º chan</h3><p>åœ¨æºç ä¸­é€šé“çš„åˆ›å»ºç”± makechan æ–¹æ³•å®ç°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šç”¨åˆ›å»ºæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makechan</span><span class="params">(t *chantype, size <span class="keyword">int</span>)</span> *<span class="title">hchan</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç±»å‹ä¸º int64 çš„è¿›è¡Œç‰¹æ®Šå¤„ç†</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makechan64</span><span class="params">(t *chantype, size <span class="keyword">int64</span>)</span> *<span class="title">hchan</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go:linkname reflect_makechan reflect.makechan</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reflect_makechan</span><span class="params">(t *chantype, size <span class="keyword">int</span>)</span> *<span class="title">hchan</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> makechan(t, size)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makechan64</span><span class="params">(t *chantype, size <span class="keyword">int64</span>)</span> *<span class="title">hchan</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">int64</span>(<span class="keyword">int</span>(size)) != size &#123;</span><br><span class="line">    <span class="built_in">panic</span>(plainError(<span class="string">&quot;makechan: size out of range&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> makechan(t, <span class="keyword">int</span>(size))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†…éƒ¨éƒ½æ˜¯è°ƒç”¨çš„ makechan æ–¹æ³•ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makechan</span><span class="params">(t *chantype, size <span class="keyword">int</span>)</span> *<span class="title">hchan</span></span> &#123;</span><br><span class="line">    elem := t.elem</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼–è¯‘å™¨æ£€æŸ¥ typesize å’Œ align</span></span><br><span class="line">    <span class="keyword">if</span> elem.size &gt;= <span class="number">1</span>&lt;&lt;<span class="number">16</span> &#123;</span><br><span class="line">        throw(<span class="string">&quot;makechan: invalid channel element type&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> hchanSize%maxAlign != <span class="number">0</span> || elem.align &gt; maxAlign &#123;</span><br><span class="line">        throw(<span class="string">&quot;makechan: bad alignment&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¡ç®—å­˜æ”¾æ•°æ®å…ƒç´ çš„å†…å­˜å¤§å°ä»¥åŠæ˜¯å¦æº¢å‡º</span></span><br><span class="line">    mem, overflow := math.MulUintptr(elem.size, <span class="keyword">uintptr</span>(size))</span><br><span class="line">    <span class="keyword">if</span> overflow || mem &gt; maxAlloc-hchanSize || size &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(plainError(<span class="string">&quot;makechan: size out of range&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> c *hchan</span><br><span class="line">    <span class="keyword">switch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> mem == <span class="number">0</span>:</span><br><span class="line">        <span class="comment">// chançš„sizeä¸º0ï¼Œæˆ–è€…æ¯ä¸ªå…ƒç´ å ç”¨çš„å¤§å°ä¸º0ï¼ˆæ¯”å¦‚struct&#123;&#125;å¤§å°å°±æ˜¯0ï¼Œä¸å ç©ºé—´ï¼‰</span></span><br><span class="line">        <span class="comment">// è¿™ç§æƒ…å†µå°±ä¸éœ€è¦å•ç‹¬ä¸ºbufåˆ†é…ç©ºé—´</span></span><br><span class="line">        c = (*hchan)(mallocgc(hchanSize, <span class="literal">nil</span>, <span class="literal">true</span>))</span><br><span class="line">        c.buf = c.raceaddr()</span><br><span class="line">    <span class="keyword">case</span> elem.ptrdata == <span class="number">0</span>:</span><br><span class="line">        <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸­ä¸å­˜åœ¨æŒ‡é’ˆï¼Œé‚£ä¹ˆæ¯ä¸ªå…ƒç´ éƒ½éœ€è¦è¢«å­˜å‚¨å¹¶å ç”¨ç©ºé—´ï¼Œå ç”¨å¤§å°ä¸ºå‰é¢ä¹˜æ³•ç®—å‡ºæ¥çš„mem</span></span><br><span class="line">        <span class="comment">// åŒæ—¶è¿˜è¦åŠ ä¸Šhchanæœ¬èº«å ç”¨çš„ç©ºé—´å¤§å°ï¼ŒåŠ èµ·æ¥å°±æ˜¯æ•´ä¸ªhchanå ç”¨çš„ç©ºé—´å¤§å°</span></span><br><span class="line">        c = (*hchan)(mallocgc(hchanSize+mem, <span class="literal">nil</span>, <span class="literal">true</span>))</span><br><span class="line">        <span class="comment">// æŠŠbufæŒ‡é’ˆæŒ‡å‘ç©ºçš„hchanå ç”¨ç©ºé—´å¤§å°çš„æœ«å°¾</span></span><br><span class="line">        c.buf = add(unsafe.Pointer(c), hchanSize)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">         <span class="comment">// å¦‚æœchanä¸­çš„å…ƒç´ æ˜¯æŒ‡é’ˆç±»å‹çš„æ•°æ®ï¼Œä¸ºbufå•ç‹¬å¼€è¾Ÿmemå¤§å°çš„ç©ºé—´ï¼Œç”¨æ¥ä¿å­˜æ‰€æœ‰çš„æ•°æ®</span></span><br><span class="line">        c = <span class="built_in">new</span>(hchan)</span><br><span class="line">        c.buf = mallocgc(mem, elem, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">// å…ƒç´ å¤§å°ã€ç±»å‹ä»¥åŠç¼“å†²åŒºå¤§å°èµ‹å€¼</span></span><br><span class="line">    c.elemsize = <span class="keyword">uint16</span>(elem.size)</span><br><span class="line">    c.elemtype = elem</span><br><span class="line">    c.dataqsiz = <span class="keyword">uint</span>(size)</span><br><span class="line">     <span class="comment">// åˆå§‹åŒ–é”</span></span><br><span class="line">    lockInit(&amp;c.lock, lockRankHchan)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>1ï¼‰é¦–å…ˆæ˜¯ç¼–è¯‘å™¨æ£€æŸ¥ï¼ŒåŒ…æ‹¬é€šé“å…ƒç´ ç±»å‹çš„ size ä»¥åŠé€šé“å’Œå…ƒç´ çš„å¯¹é½ï¼Œç„¶åè®¡ç®—å­˜æ”¾æ•°æ®å…ƒç´ çš„å†…å­˜å¤§å°ä»¥åŠæ˜¯å¦æº¢å‡º</li>
<li>2ï¼‰ç„¶åæ ¹æ®ä¸åŒæ¡ä»¶è¿›è¡Œå†…å­˜åˆ†é…<ul>
<li>æ€»ä½“çš„åŸåˆ™æ˜¯ï¼šæ€»å†…å­˜å¤§å° = hchan éœ€è¦çš„å†…å­˜å¤§å° + å…ƒç´ éœ€è¦çš„å†…å­˜å¤§å°</li>
<li>é˜Ÿåˆ—ä¸ºç©ºæˆ–å…ƒç´ å¤§å°ä¸º 0ï¼šåªéœ€è¦å¼€è¾Ÿçš„å†…å­˜ç©ºé—´ä¸º hchan æœ¬èº«çš„å¤§å°</li>
<li>å…ƒç´ ä¸æ˜¯æŒ‡é’ˆç±»å‹ï¼šéœ€è¦å¼€è¾Ÿçš„å†…å­˜ç©ºé—´ = hchan æœ¬èº«å¤§å° + æ¯ä¸ªå…ƒç´ çš„å¤§å° * ç”³è¯·çš„é˜Ÿåˆ—é•¿åº¦</li>
<li>å…ƒç´ æ˜¯æŒ‡é’ˆç±»å‹ï¼šè¿™ç§æƒ…å†µä¸‹ buf éœ€è¦å•ç‹¬å¼€è¾Ÿç©ºé—´ï¼Œbuf å ç”¨å†…å­˜å¤§å°ä¸ºæ¯ä¸ªå…ƒç´ çš„å¤§å° * ç”³è¯·çš„é˜Ÿåˆ—é•¿åº¦<br>3ï¼‰æœ€ååˆ™å¯¹ chan çš„å…¶ä»–å­—æ®µèµ‹å€¼</li>
</ul>
</li>
</ul>
<h3 id="3-2-å‘é€æ•°æ®"><a href="#3-2-å‘é€æ•°æ®" class="headerlink" title="3.2 å‘é€æ•°æ®"></a>3.2 å‘é€æ•°æ®</h3><p>å‘é€æ•°æ®åˆ° channel æ—¶ï¼Œç›´è§‚çš„ç†è§£æ˜¯å°†æ•°æ®æ”¾åˆ° chan çš„ç¯å½¢é˜Ÿåˆ—ä¸­ï¼Œä¸è¿‡ go åšäº†ä¸€äº›ä¼˜åŒ–ï¼š</p>
<ul>
<li>å…ˆåˆ¤æ–­æ˜¯å¦æœ‰ç­‰å¾…æ¥æ”¶æ•°æ®çš„ groutineï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥å°†æ•°æ®å‘ç»™ Groutineï¼Œå”¤é†’ groutineï¼Œå°±ä¸æ”¾å…¥é˜Ÿåˆ—ä¸­äº†ã€‚<ul>
<li>è¿™æ ·çœå»äº†ä¸¤æ¬¡å†…å­˜æ‹·è´å’ŒåŠ é”çš„å¼€é”€</li>
</ul>
</li>
<li>å½“ç„¶è¿˜æœ‰å¦å¤–ä¸€ç§æƒ…å†µå°±æ˜¯ï¼šé˜Ÿåˆ—å¦‚æœæ»¡äº†ï¼Œé‚£å°±åªèƒ½æ”¾åˆ°é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œç›´åˆ°æœ‰æ•°æ®è¢«å–èµ°æ‰èƒ½å‘é€ã€‚</li>
</ul>
<p>chan çš„å‘é€é€»è¾‘æ¶‰åŠåˆ° 5 ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">selectnbsend</span><span class="params">(c *hchan, elem unsafe.Pointer)</span> <span class="params">(selected <span class="keyword">bool</span>)</span></span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chansend1</span><span class="params">(c *hchan, elem unsafe.Pointer)</span></span> &#123;â€¦&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chansend</span><span class="params">(c *hchan, ep unsafe.Pointer, block <span class="keyword">bool</span>, callerpc <span class="keyword">uintptr</span>)</span> <span class="title">bool</span></span> &#123;â€¦&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf <span class="keyword">func</span>()</span>, <span class="title">skip</span> <span class="title">int</span>)</span> &#123;â€¦&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendDirect</span><span class="params">(t *_type, sg *sudog, src unsafe.Pointer)</span></span> &#123;â€¦&#125;</span><br></pre></td></tr></table></figure>

<p>chansend1 æ–¹æ³•æ˜¯ go ç¼–è¯‘ä»£ç ä¸­<code>c &lt;- x</code>è¿™ç§å†™æ³•çš„å…¥å£ç‚¹ï¼Œå³å½“æˆ‘ä»¬ç¼–å†™ä»£ç  <code>c &lt;- x</code>å…¶å®å°±æ˜¯è°ƒç”¨æ­¤æ–¹æ³•ã€‚ è¿™å››ä¸ªæ–¹æ³•çš„è°ƒç”¨å…³ç³»ï¼š<code>chansend1 -&gt; chansend -&gt; send -&gt; sendDirect</code></p>
<p>å…·ä½“å‘é€é€»è¾‘åœ¨<code>chansend</code>è¿™ä¸ªæ–¹æ³•é‡Œï¼Œç„¶åçœŸæ­£ä½¿ç”¨çš„æ–¹æ³•å…¶å®æ˜¯å¯¹è¯¥æ–¹æ³•çš„ä¸€å±‚åŒ…è£…ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chansend1</span><span class="params">(c *hchan, elem unsafe.Pointer)</span></span> &#123;</span><br><span class="line">    chansend(c, elem, <span class="literal">true</span>, getcallerpc())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">selectnbsend</span><span class="params">(c *hchan, elem unsafe.Pointer)</span> <span class="params">(selected <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> chansend(c, elem, <span class="literal">false</span>, getcallerpc())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chansend</span><span class="params">(c *hchan, ep unsafe.Pointer, block <span class="keyword">bool</span>, callerpc <span class="keyword">uintptr</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ channel æ˜¯å¦ä¸º nil</span></span><br><span class="line">    <span class="keyword">if</span> c == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> !block &#123;<span class="comment">// å¦‚æœéé˜»å¡ï¼Œç›´æ¥è¿”å› false</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å½“å‘ nil channel å‘é€æ•°æ®æ—¶ï¼Œä¼šè°ƒç”¨ gopark</span></span><br><span class="line">        <span class="comment">// è€Œ gopark ä¼šå°†å½“å‰çš„ goroutine ä¼‘çœ ï¼Œå¹¶ç”¨è¿‡ç¬¬ä¸€ä¸ªå‚æ•°çš„ unlockf æ¥å›è°ƒå”¤é†’</span></span><br><span class="line">        <span class="comment">// ä½†æ­¤å¤„ä¼ é€’çš„å‚æ•°ä¸º nilï¼Œå› æ­¤å‘ channel å‘é€æ•°æ®çš„ goroutine å’Œæ¥æ”¶æ•°æ®çš„ goroutine éƒ½ä¼šé˜»å¡ï¼Œè¿›è€Œæ­»é”</span></span><br><span class="line">        gopark(<span class="literal">nil</span>, <span class="literal">nil</span>, waitReasonChanSendNilChan, traceEvGoStop, <span class="number">2</span>)</span><br><span class="line">        throw(<span class="string">&quot;unreachable&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">        racereadpc(c.raceaddr(), callerpc, funcPC(chansend))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹äºä¸é˜»å¡çš„ sendï¼Œå¿«é€Ÿæ£€æµ‹å¤±è´¥åœºæ™¯</span></span><br><span class="line">    <span class="comment">// å¦‚æœ channel æœªå…³é—­ä¸” channel æ²¡æœ‰å¤šä½™çš„ç¼“å†²ç©ºé—´ã€‚è¿™å¯èƒ½æ˜¯ï¼š</span></span><br><span class="line">    <span class="comment">// 1. channel æ˜¯éç¼“å†²å‹çš„ï¼Œä¸”ç­‰å¾…æ¥æ”¶é˜Ÿåˆ—é‡Œæ²¡æœ‰ goroutine</span></span><br><span class="line">    <span class="comment">// 2. channel æ˜¯ç¼“å†²å‹çš„ï¼Œä½†å¾ªç¯æ•°ç»„å·²ç»è£…æ»¡äº†å…ƒç´ </span></span><br><span class="line">    <span class="comment">// ä¸»è¦ç”¨äº select è¯­å¥ä¸­ï¼Œæ¶‰åŠåˆ°æŒ‡ä»¤é‡æ’é˜Ÿ+å¯è§‚æµ‹æ€§</span></span><br><span class="line">    <span class="keyword">if</span> !block &amp;&amp; c.closed == <span class="number">0</span> &amp;&amp; full(c) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> t0 <span class="keyword">int64</span></span><br><span class="line">    <span class="keyword">if</span> blockprofilerate &gt; <span class="number">0</span> &#123;</span><br><span class="line">        t0 = cputicks()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŠ é”,é¿å…ç«äº‰</span></span><br><span class="line">    lock(&amp;c.lock)</span><br><span class="line">    <span class="comment">// æ£€æŸ¥ channel æ˜¯å¦å·²å…³é—­ï¼Œä¸å…è®¸å‘å…³é—­çš„ channel å‘é€æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">        unlock(&amp;c.lock)</span><br><span class="line">        <span class="built_in">panic</span>(plainError(<span class="string">&quot;send on closed channel&quot;</span>)) <span class="comment">// ç›´æ¥panic</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä» recvq é˜Ÿé¦–å–å‡ºä¸€ä¸ªæ¥æ”¶è€…ï¼Œå¦‚æœå­˜åœ¨æ¥æ”¶è€…ï¼Œå°±ç»•è¿‡ç¯å½¢é˜Ÿåˆ—ï¼ˆbufï¼‰ç›´æ¥æŠŠ ep æ‹·è´ç»™ sgï¼Œå¹¶é‡Šæ”¾é”</span></span><br><span class="line">    <span class="comment">// è¿™å°±æ˜¯å‰é¢æåˆ°çš„ï¼Œå®˜æ–¹åšçš„ä¸€ä¸ªä¼˜åŒ–ï¼Œå¦‚æœæœ‰goroutineåœ¨ç­‰å¾…å°±ç›´æ¥æŠŠæ•°æ®ç»™è¯¥goroutineï¼Œæ²¡å¿…è¦åœ¨å†™åˆ°bufï¼Œç„¶åæ¥æ”¶è€…åˆä»bufä¸­æ‹·è´å‡ºæ¥</span></span><br><span class="line">    <span class="keyword">if</span> sg := c.recvq.dequeue(); sg != <span class="literal">nil</span> &#123;</span><br><span class="line">        send(c, sg, ep, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ°è¿™é‡Œè¯´æ˜å½“å‰æ²¡æœ‰ç­‰å¾…çŠ¶æ€çš„æ¥æ”¶è€…</span></span><br><span class="line">    <span class="comment">// å¦‚æœç¯å½¢é˜Ÿåˆ—è¿˜æœªæ»¡</span></span><br><span class="line">    <span class="keyword">if</span> c.qcount &lt; c.dataqsiz &#123;</span><br><span class="line">        <span class="comment">// æ‹¿åˆ° sendx ç´¢å¼•çš„ä½ç½®</span></span><br><span class="line">        qp := chanbuf(c, c.sendx)</span><br><span class="line">        <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">            racenotify(c, c.sendx, <span class="literal">nil</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç›´æ¥æŠŠæ•°æ®ä» qp æ‹·è´åˆ° qpï¼Œå°±æ˜¯æŠŠæ•°æ®æ‹·è´åˆ°ç¯å½¢é˜Ÿåˆ—ä¸­</span></span><br><span class="line">        typedmemmove(c.elemtype, qp, ep)</span><br><span class="line">        <span class="comment">// ç»´æŠ¤ snedx çš„å€¼ï¼Œå› ä¸ºæ˜¯ç¯å½¢é˜Ÿåˆ—ï¼Œæ‰€ä»¥åˆ°æœ€å¤§å€¼æ—¶å°±é‡ç½®ä¸º0</span></span><br><span class="line">        c.sendx++</span><br><span class="line">        <span class="keyword">if</span> c.sendx == c.dataqsiz &#123;</span><br><span class="line">            c.sendx = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//qcountå³å½“å‰chanä¸­çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">        c.qcount++</span><br><span class="line">        unlock(&amp;c.lock)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ°è¿™é‡Œè¯´æ˜ç¯å½¢é˜Ÿåˆ—å·²ç»æ»¡äº†</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¿˜æ˜¯è¦éé˜»å¡çš„æ–¹å¼å‘é€ï¼Œå°±åªèƒ½è¿”å›é”™è¯¯äº†</span></span><br><span class="line">    <span class="keyword">if</span> !block &#123;</span><br><span class="line">        unlock(&amp;c.lock)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ°è¿™é‡Œè¯´æ˜ç¼“å­˜é˜Ÿåˆ—æ»¡äº†ï¼Œç„¶åè°ƒç”¨æ³•æŒ‡å®šæ˜¯é˜»å¡æ–¹å¼è¿›è¡Œå‘é€</span></span><br><span class="line">    <span class="comment">// channel æ»¡äº†ï¼Œå‘é€æ–¹ä¼šè¢«é˜»å¡ã€‚æ¥ä¸‹æ¥ä¼šæ„é€ ä¸€ä¸ª sudog</span></span><br><span class="line">    gp := getg()    <span class="comment">// è·å–å½“å‰ goroutine</span></span><br><span class="line">    mysg := acquireSudog()<span class="comment">// ä»å¯¹è±¡æ± è·å– sudog</span></span><br><span class="line">    mysg.releasetime = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> t0 != <span class="number">0</span> &#123;</span><br><span class="line">        mysg.releasetime = <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æŠŠå‘é€çš„æ•°æ®(ep)ã€å½“å‰g(gp)ã€å·²ç»å½“å‰è¿™ä¸ªchan(c)éƒ½å­˜åˆ°sudogä¸­</span></span><br><span class="line">    mysg.elem = ep</span><br><span class="line">    mysg.waitlink = <span class="literal">nil</span></span><br><span class="line">    mysg.g = gp</span><br><span class="line">    mysg.isSelect = <span class="literal">false</span></span><br><span class="line">    mysg.c = c</span><br><span class="line">    <span class="comment">// ä¿å­˜å½“å‰ sudogï¼Œä¸‹é¢è¦ç”¨åˆ°åšæ ¡éªŒ</span></span><br><span class="line">    gp.waiting = mysg</span><br><span class="line">    gp.param = <span class="literal">nil</span></span><br><span class="line">     <span class="comment">// æŠŠè¿™ä¸ªsudogå­˜å…¥sendqé˜Ÿåˆ—</span></span><br><span class="line">    c.sendq.enqueue(mysg)</span><br><span class="line">    atomic.Store8(&amp;gp.parkingOnChan, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">// è°ƒç”¨goparkï¼ŒæŒ‚èµ·å½“å‰çš„ gï¼Œå°†å½“å‰çš„ g ç§»å‡ºè°ƒåº¦å™¨çš„é˜Ÿåˆ—</span></span><br><span class="line">    gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanSend, traceEvGoBlockSend, <span class="number">2</span>)</span><br><span class="line">    <span class="comment">// ç­‰åˆ°æœ‰æ¥æ”¶è€…ä»chanä¸­å–å€¼çš„æ—¶å€™ï¼Œè¿™ä¸ªå‘é€çš„gåˆä¼šè¢«é‡æ–°è°ƒåº¦ï¼Œç„¶åä»è¿™é‡Œå¼€å§‹ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">    KeepAlive(ep)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€éªŒæ˜¯å¦ä¸ºå½“å‰çš„ sudog</span></span><br><span class="line">    <span class="keyword">if</span> mysg != gp.waiting &#123;</span><br><span class="line">        throw(<span class="string">&quot;G waiting list is corrupted&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    gp.waiting = <span class="literal">nil</span></span><br><span class="line">    gp.activeStackChans = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œsudogä¸­çš„successè¡¨ç¤ºçš„æ˜¯å½“å‰è¿™ä¸ªé€šé“ä¸Šæ˜¯å¦è¿›è¡Œè¿‡é€šä¿¡</span></span><br><span class="line">    <span class="comment">// ä¸º true åˆ™è¯´æ˜æ˜¯çœŸæ­£çš„å”¤é†’ï¼Œchanä¸Šæœ‰æ´»åŠ¨ï¼ˆæœ‰æ•°æ®å†™è¿›æ¥ï¼Œæˆ–è€…æœ‰æ•°æ®è¢«è¯»å–å‡ºå»ï¼‰</span></span><br><span class="line">    <span class="comment">// ä¸º false åˆ™è¯´æ˜æ˜¯å‡çš„å”¤é†’ï¼Œå³å½“å‰å”¤é†’æ˜¯å¦å…³é—­chanå¯¼è‡´çš„</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œä¸»è¦æ ¹æ®è¿™ä¸ªå€¼åˆ¤æ–­chanæ˜¯å¦è¢«å…³é—­äº†</span></span><br><span class="line">    closed := !mysg.success</span><br><span class="line">    gp.param = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">if</span> mysg.releasetime &gt; <span class="number">0</span> &#123;</span><br><span class="line">        blockevent(mysg.releasetime-t0, <span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    mysg.c = <span class="literal">nil</span></span><br><span class="line">    <span class="comment">// å°† sudog æ”¾å›å¯¹è±¡æ± </span></span><br><span class="line">    releaseSudog(mysg)</span><br><span class="line">    <span class="keyword">if</span> closed &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœchanè¢«å…³é—­äº†ä¹Ÿæ˜¯ç›´æ¥panic</span></span><br><span class="line">        <span class="keyword">if</span> c.closed == <span class="number">0</span> &#123;</span><br><span class="line">            throw(<span class="string">&quot;chansend: spurious wakeup&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">panic</span>(plainError(<span class="string">&quot;send on closed channel&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¸å¿ƒé€»è¾‘</p>
<ul>
<li>å¦‚æœ recvq ä¸ä¸ºç©ºï¼Œä» recvq ä¸­å–å‡ºä¸€ä¸ªç­‰å¾…æ¥æ”¶æ•°æ®çš„ Groutineï¼Œç›´æ¥å°†æ•°æ®å‘é€ç»™è¯¥ Groutine</li>
<li>å¦‚æœ recvq ä¸ºç©ºï¼Œæ‰å°†æ•°æ®æ”¾å…¥ buf ä¸­</li>
<li>å¦‚æœ buf å·²æ»¡ï¼Œåˆ™å°†è¦å‘é€çš„æ•°æ®å’Œå½“å‰çš„ Groutine æ‰“åŒ…æˆ Sudog å¯¹è±¡æ”¾å…¥ sendqï¼Œå¹¶å°† groutine ç½®ä¸ºç­‰å¾…çŠ¶æ€</li>
<li>ç­‰ goroutine å†æ¬¡è¢«è°ƒåº¦æ—¶ç¨‹åºç»§ç»­æ‰§è¡Œ</li>
</ul>
<p>ç„¶åè¿½è¸ªä¸€ä¸‹ send æ–¹æ³•ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf <span class="keyword">func</span>()</span>, <span class="title">skip</span> <span class="title">int</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// å¿½ç•¥ race æ£€æŸ¥..</span></span><br><span class="line">    <span class="keyword">if</span> sg.elem != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// ç›´æ¥æ‹·è´åˆ°æ¥å—è€…å†…å­˜ï¼Œä½¿ç”¨å†™å±éšœ</span></span><br><span class="line">        sendDirect(c.elemtype, sg, ep)</span><br><span class="line">        sg.elem = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    gp := sg.g <span class="comment">// å–å‡ºsudogä¸­è®°å½•çš„gï¼Œè¿™é‡Œçš„gå°±æ˜¯è¢«é˜»å¡æ¥æ”¶è€…</span></span><br><span class="line">    unlockf()</span><br><span class="line">    gp.param = unsafe.Pointer(sg) <span class="comment">// æ›´æ–°æ¥æ”¶è€…gçš„paramå­—æ®µï¼Œåœ¨recvæ–¹æ³•ä¸­ä¼šç”¨åˆ°</span></span><br><span class="line">    sg.success = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> sg.releasetime != <span class="number">0</span> &#123;</span><br><span class="line">        sg.releasetime = cputicks()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æœ€åæŠŠè¢«é˜»å¡çš„æ¥æ”¶è€…gå”¤é†’</span></span><br><span class="line">    goready(gp, skip+<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­çœ‹ sendDirect æ–¹æ³•ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendDirect</span><span class="params">(t *_type, sg *sudog, src unsafe.Pointer)</span></span> &#123;</span><br><span class="line">    <span class="comment">// src åœ¨å½“å‰ goroutine çš„æ ˆä¸Šï¼Œdst æ˜¯å¦ä¸€ä¸ª goroutine çš„æ ˆ</span></span><br><span class="line">    <span class="comment">// ç›´æ¥è¿›è¡Œå†…å­˜&quot;æ¬è¿&quot;</span></span><br><span class="line">    <span class="comment">// å¦‚æœç›®æ ‡åœ°å€çš„æ ˆå‘ç”Ÿäº†æ ˆæ”¶ç¼©ï¼Œå½“æˆ‘ä»¬è¯»å‡ºäº† sg.elem å</span></span><br><span class="line">    <span class="comment">// å°±ä¸èƒ½ä¿®æ”¹çœŸæ­£çš„ dst ä½ç½®çš„å€¼äº†</span></span><br><span class="line">    <span class="comment">// å› æ­¤éœ€è¦åœ¨è¯»å’Œå†™ä¹‹å‰åŠ ä¸Šä¸€ä¸ªå±éšœ</span></span><br><span class="line">    dst := sg.elem</span><br><span class="line">    typeBitsBulkBarrier(t, <span class="keyword">uintptr</span>(dst), <span class="keyword">uintptr</span>(src), t.size)</span><br><span class="line">     <span class="comment">// æ‹·è´å†…å­˜</span></span><br><span class="line">    memmove(dst, src, t.size)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ª goroutine ç›´æ¥å†™å¦ä¸€ä¸ª goroutine æ ˆçš„æ“ä½œï¼Œä¸€èˆ¬è€Œè¨€ï¼Œä¸åŒ goroutine çš„æ ˆæ˜¯å„è‡ªç‹¬æœ‰çš„ã€‚è€Œè¿™ä¹Ÿè¿åäº† GC çš„ä¸€äº›å‡è®¾ã€‚ä¸ºäº†ä¸å‡ºé—®é¢˜ï¼Œå†™çš„è¿‡ç¨‹ä¸­å¢åŠ äº†å†™å±éšœï¼Œä¿è¯æ­£ç¡®åœ°å®Œæˆå†™æ“ä½œã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å‡å°‘äº†ä¸€æ¬¡å†…å­˜ copyï¼šä¸ç”¨å…ˆæ‹·è´åˆ° channel çš„ bufï¼Œç›´æ¥ç”±å‘é€è€…åˆ°æ¥æ”¶è€…ï¼Œæ²¡æœ‰ä¸­é—´å•†èµšå·®ä»·ï¼Œæ•ˆç‡å¾—ä»¥æé«˜ï¼Œå®Œç¾ã€‚</p>
<h3 id="3-3-æ¥æ”¶æ•°æ®"><a href="#3-3-æ¥æ”¶æ•°æ®" class="headerlink" title="3.3 æ¥æ”¶æ•°æ®"></a>3.3 æ¥æ”¶æ•°æ®</h3><p>ä» channel è¯»å–æ•°æ®çš„æµç¨‹å’Œå‘é€çš„ç±»ä¼¼ï¼ŒåŸºæœ¬æ˜¯å‘é€æ“ä½œçš„é€†æ“ä½œã€‚</p>
<p>è¿™é‡ŒåŒæ ·å­˜åœ¨å’Œ send ä¸€æ ·çš„ä¼˜åŒ–ï¼šä» channel è¯»å–æ•°æ®æ—¶ï¼Œä¸æ˜¯ç›´æ¥å»ç¯å½¢é˜Ÿåˆ—ä¸­å»æ•°æ®ï¼Œè€Œæ˜¯å…ˆåˆ¤æ–­æ˜¯å¦æœ‰ç­‰å¾…å‘é€æ•°æ®çš„ groutineã€‚å¦‚æœæœ‰ï¼Œç›´æ¥å°† groutine å‡ºé˜Ÿåˆ—ï¼Œå–å‡ºæ•°æ®è¿”å›ï¼Œå¹¶å”¤é†’ groutineã€‚å¦‚æœæ²¡æœ‰ç­‰å¾…å‘é€æ•°æ®çš„ groutineï¼Œå†ä»ç¯å½¢é˜Ÿåˆ—ä¸­å–æ•°æ®ã€‚</p>
<p>chan çš„æ¥æ”¶æ¶‰åŠåˆ° 7 ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reflect_chanrecv</span><span class="params">(c *hchan, nb <span class="keyword">bool</span>, elem unsafe.Pointer)</span> <span class="params">(selected <span class="keyword">bool</span>, received <span class="keyword">bool</span>)</span></span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">selectnbrecv</span><span class="params">(elem unsafe.Pointer, c *hchan)</span> <span class="params">(selected, received <span class="keyword">bool</span>)</span></span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanrecv1</span><span class="params">(c *hchan, elem unsafe.Pointer)</span></span> &#123;â€¦&#125;ï¼Œ</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanrecv2</span><span class="params">(c *hchan, elem unsafe.Pointer)</span> <span class="params">(received <span class="keyword">bool</span>)</span></span> &#123;â€¦&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanrecv</span><span class="params">(c *hchan, ep unsafe.Pointer, block <span class="keyword">bool</span>)</span> <span class="params">(selected, received <span class="keyword">bool</span>)</span></span> &#123;â€¦&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf <span class="keyword">func</span>()</span>, <span class="title">skip</span> <span class="title">int</span>)</span> &#123;â€¦&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recvDirect</span><span class="params">(t *_type, sg *sudog, dst unsafe.Pointer)</span></span> &#123;â€¦&#125;</span><br></pre></td></tr></table></figure>

<p>æŒ‰ç…§å‘é€æ—¶çš„å¥—è·¯å¯çŸ¥ï¼Œåªæœ‰ chanrecv æ˜¯å…·ä½“é€»è¾‘ï¼Œä¸Šé¢å‡ ä¸ªéƒ½æ˜¯åŒ…è£…æ–¹æ³•ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:linkname reflect_chanrecv reflect.chanrecv</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reflect_chanrecv</span><span class="params">(c *hchan, nb <span class="keyword">bool</span>, elem unsafe.Pointer)</span> <span class="params">(selected <span class="keyword">bool</span>, received <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> chanrecv(c, elem, !nb)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">selectnbrecv</span><span class="params">(elem unsafe.Pointer, c *hchan)</span> <span class="params">(selected, received <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> chanrecv(c, elem, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanrecv1</span><span class="params">(c *hchan, elem unsafe.Pointer)</span></span> &#123;</span><br><span class="line">    chanrecv(c, elem, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanrecv2</span><span class="params">(c *hchan, elem unsafe.Pointer)</span> <span class="params">(received <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    _, received = chanrecv(c, elem, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥æ”¶æ“ä½œæœ‰ä¸¤ç§å†™æ³•ï¼Œä¸€ç§å¸¦ â€œokâ€ï¼Œååº” channel æ˜¯å¦å…³é—­ï¼›</p>
<p>ä¸€ç§ä¸å¸¦ â€œokâ€ï¼Œè¿™ç§å†™æ³•ï¼Œå½“æ¥æ”¶åˆ°ç›¸åº”ç±»å‹çš„é›¶å€¼æ—¶æ— æ³•çŸ¥é“æ˜¯çœŸå®çš„å‘é€è€…å‘é€è¿‡æ¥çš„å€¼ï¼Œè¿˜æ˜¯ channel è¢«å…³é—­åï¼Œè¿”å›ç»™æ¥æ”¶è€…çš„é»˜è®¤ç±»å‹çš„é›¶å€¼ã€‚</p>
<p>ä¸¤ç§å†™æ³•ï¼Œéƒ½æœ‰å„è‡ªçš„åº”ç”¨åœºæ™¯ã€‚</p>
<p>ç»è¿‡ç¼–è¯‘å™¨çš„å¤„ç†åï¼Œè¿™ä¸¤ç§å†™æ³•æœ€åå¯¹åº”æºç é‡Œçš„å°±æ˜¯ä¸å¸¦<code>ok</code>çš„<code>chanrecv1</code>å’Œå¸¦<code>ok</code>çš„<code>chanrecv2</code>è¿™ä¸¤ä¸ªå‡½æ•°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chanrecv å‡½æ•°æ¥æ”¶ channel c çš„å…ƒç´ å¹¶å°†å…¶å†™å…¥ ep æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœ ep æ˜¯ nilï¼Œè¯´æ˜å¿½ç•¥äº†æ¥æ”¶å€¼ã€‚æ¯”å¦‚ &lt;-ch è¿™æ ·ï¼Œæ²¡æœ‰æ¥æ”¶å–åˆ°çš„å€¼</span></span><br><span class="line"><span class="comment">// å¦‚æœ block == falseï¼Œå³éé˜»å¡å‹æ¥æ”¶ï¼Œåœ¨æ²¡æœ‰æ•°æ®å¯æ¥æ”¶çš„æƒ…å†µä¸‹ï¼Œè¿”å› (false, false)</span></span><br><span class="line"><span class="comment">// å¦åˆ™ï¼Œå¦‚æœ c å¤„äºå…³é—­çŠ¶æ€ï¼Œå°† ep æŒ‡å‘çš„åœ°å€æ¸…é›¶ï¼Œè¿”å› (true, false)</span></span><br><span class="line"><span class="comment">// å¦åˆ™ï¼Œç”¨è¿”å›å€¼å¡«å…… ep æŒ‡å‘çš„å†…å­˜åœ°å€ã€‚è¿”å› (true, true)</span></span><br><span class="line"><span class="comment">// å¦‚æœ ep éç©ºï¼Œåˆ™åº”è¯¥æŒ‡å‘å †æˆ–è€…å‡½æ•°è°ƒç”¨è€…çš„æ ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chanrecv</span><span class="params">(c *hchan, ep unsafe.Pointer, block <span class="keyword">bool</span>)</span> <span class="params">(selected, received <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ä¸€ä¸ª nil çš„ channel    </span></span><br><span class="line">    <span class="keyword">if</span> c == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸é˜»å¡ï¼Œç›´æ¥è¿”å› (false, false)</span></span><br><span class="line">        <span class="keyword">if</span> !block &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦åˆ™ï¼Œæ¥æ”¶ä¸€ä¸ª nil çš„ channelï¼Œè°ƒç”¨goparkå°†goroutine æŒ‚èµ·</span></span><br><span class="line">        gopark(<span class="literal">nil</span>, <span class="literal">nil</span>, waitReasonChanReceiveNilChan, traceEvGoStop, <span class="number">2</span>)</span><br><span class="line">        throw(<span class="string">&quot;unreachable&quot;</span>) <span class="comment">// è¢«æŒ‚èµ·ä¹‹åä¸ä¼šæ‰§è¡Œåˆ°è¿™ä¸€å¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™å—ä¸»è¦ç”¨åœ¨ select è¯­å¥ä¸­ï¼Œå…ˆå¤§æ¦‚äº†è§£ä¸‹ï¼Œæ¯”è¾ƒéš¾æ‡‚ã€‚ã€‚ã€‚</span></span><br><span class="line">    <span class="comment">// å¿«é€Ÿè·¯å¾„: åœ¨ä¸éœ€è¦é”çš„æƒ…å†µä¸‹æ£€æŸ¥å¤±è´¥çš„éé˜»å¡æ“ä½œ</span></span><br><span class="line">    <span class="comment">// æ³¨æ„åˆ° channel ä¸èƒ½ç”±å·²å…³é—­è½¬æ¢ä¸ºæœªå…³é—­ï¼Œåˆ™å¤±è´¥çš„æ¡ä»¶æ˜¯ï¼š</span></span><br><span class="line">    <span class="comment">// 1. channel æ˜¯éç¼“å†²å‹çš„ï¼Œrecvq é˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line">    <span class="comment">// 2. channel æ˜¯ç¼“å†²å‹çš„ï¼Œbuf ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> !block &amp;&amp; empty(c) &#123;</span><br><span class="line">        <span class="comment">// æ­¤å¤„çš„ c.closed å¿…é¡»åœ¨æ¡ä»¶åˆ¤æ–­ä¹‹åè¿›è¡ŒéªŒè¯ï¼Œ</span></span><br><span class="line">        <span class="comment">// å› ä¸ºæŒ‡ä»¤é‡æ’åï¼Œå¦‚æœå…ˆåˆ¤æ–­ c.closedï¼Œå¾—å‡º channel æœªå…³é—­ï¼Œæ— æ³•åˆ¤æ–­å¤±è´¥æ¡ä»¶ä¸­channel æ˜¯å·²å…³é—­è¿˜æ˜¯æœªå…³é—­ï¼ˆä»è€Œéœ€è¦ atomic æ“ä½œï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> atomic.Load(&amp;c.closed) == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å†æ¬¡æ£€æŸ¥ channel æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> empty(c) &#123;</span><br><span class="line">            <span class="comment">// æ¥æ”¶è€…ä¸ä¸º nil æ—¶è¿”å›è¯¥ç±»å‹çš„é›¶å€¼</span></span><br><span class="line">            <span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="comment">// typedmemclr é€»è¾‘æ˜¯æ ¹æ®ç±»å‹æ¸…ç†ç›¸åº”åœ°å€çš„å†…å­˜</span></span><br><span class="line">                typedmemclr(c.elemtype, ep)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è¿”å›ï¼ˆtrue,fasleï¼‰</span></span><br><span class="line">            <span class="comment">// è¿”å›å€¼1--trueï¼šè¡¨ç¤ºè¢« select case é€‰ä¸­ï¼Œ</span></span><br><span class="line">            <span class="comment">// è¿”å›å€¼2--fasle è¡¨ç¤ºæ˜¯å¦æ­£å¸¸æ”¶åˆ°æ•°æ®</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> t0 <span class="keyword">int64</span></span><br><span class="line">    <span class="keyword">if</span> blockprofilerate &gt; <span class="number">0</span> &#123;</span><br><span class="line">        t0 = cputicks()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŠ é”ï¼Œä¿è¯å¹¶å‘å®‰å…¨</span></span><br><span class="line">    lock(&amp;c.lock)</span><br><span class="line">    <span class="comment">// channel å·²å…³é—­ï¼Œå¹¶ä¸”å¾ªç¯æ•°ç»„ buf é‡Œæ²¡æœ‰å…ƒç´ </span></span><br><span class="line">    <span class="comment">// è¿™é‡Œå¯ä»¥å¤„ç†éç¼“å†²å‹å…³é—­ å’Œ ç¼“å†²å‹å…³é—­ä½† buf æ— å…ƒç´ çš„æƒ…å†µ</span></span><br><span class="line">    <span class="comment">// ä¹Ÿå°±æ˜¯è¯´å³ä½¿æ˜¯å…³é—­çŠ¶æ€ï¼Œä½†åœ¨ç¼“å†²å‹çš„ channelï¼Œ</span></span><br><span class="line">    <span class="comment">// buf é‡Œæœ‰å…ƒç´ çš„æƒ…å†µä¸‹è¿˜èƒ½æ¥æ”¶åˆ°å…ƒç´ </span></span><br><span class="line">    <span class="keyword">if</span> c.closed != <span class="number">0</span> &amp;&amp; c.qcount == <span class="number">0</span> &#123;</span><br><span class="line">        unlock(&amp;c.lock)</span><br><span class="line">        <span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</span><br><span class="line">            typedmemclr(c.elemtype, ep)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰å¾…å‘é€é˜Ÿåˆ—é‡Œæœ‰ goroutine å­˜åœ¨ï¼Œè¯´æ˜ buf æ˜¯æ»¡çš„</span></span><br><span class="line">    <span class="comment">// è¿™æœ‰å¯èƒ½æ˜¯ï¼š</span></span><br><span class="line">    <span class="comment">// 1. éç¼“å†²å‹çš„ channel</span></span><br><span class="line">    <span class="comment">// 2. ç¼“å†²å‹çš„ channelï¼Œä½† buf æ»¡äº†</span></span><br><span class="line">    <span class="comment">// é’ˆå¯¹ 1ï¼Œç›´æ¥è¿›è¡Œå†…å­˜æ‹·è´ï¼ˆä» sender goroutine -&gt; receiver goroutineï¼‰</span></span><br><span class="line">    <span class="comment">// é’ˆå¯¹ 2ï¼Œæ¥æ”¶åˆ°å¾ªç¯æ•°ç»„å¤´éƒ¨çš„å…ƒç´ ï¼Œå¹¶å°†å‘é€è€…çš„å…ƒç´ æ”¾åˆ°å¾ªç¯æ•°ç»„å°¾éƒ¨</span></span><br><span class="line">    <span class="keyword">if</span> sg := c.sendq.dequeue(); sg != <span class="literal">nil</span> &#123;</span><br><span class="line">        recv(c, sg, ep, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// chançš„buf é‡Œæœ‰å…ƒç´ ï¼Œå¯ä»¥æ­£å¸¸æ¥æ”¶</span></span><br><span class="line">    <span class="keyword">if</span> c.qcount &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// ç›´æ¥ä»å¾ªç¯æ•°ç»„é‡Œæ‰¾åˆ°è¦æ¥æ”¶çš„å…ƒç´ </span></span><br><span class="line">        qp := chanbuf(c, c.recvx)</span><br><span class="line">        <span class="comment">// ep != nilè¡¨ç¤ºä»£ç é‡Œï¼Œæ²¡æœ‰å¿½ç•¥è¦æ¥æ”¶çš„å€¼</span></span><br><span class="line">        <span class="comment">// å³æ¥æ”¶çš„ä»£ç ä¸æ˜¯ &quot;&lt;- ch&quot;ï¼Œè€Œæ˜¯ &quot;val &lt;- ch&quot;è¿™ç§ï¼Œep æŒ‡å‘ val</span></span><br><span class="line">        <span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</span><br><span class="line">            typedmemmove(c.elemtype, ep, qp)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ¸…ç†æ‰å¾ªç¯æ•°ç»„é‡Œç›¸åº”ä½ç½®çš„å€¼</span></span><br><span class="line">        typedmemclr(c.elemtype, qp)</span><br><span class="line">        <span class="comment">// ç»´æŠ¤æ¥æ”¶æ¸¸æ ‡</span></span><br><span class="line">        c.recvx++</span><br><span class="line">        <span class="keyword">if</span> c.recvx == c.dataqsiz &#123;</span><br><span class="line">            c.recvx = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// buf æ•°ç»„é‡Œçš„å…ƒç´ ä¸ªæ•°å‡ 1</span></span><br><span class="line">        c.qcount--</span><br><span class="line">        <span class="comment">// å¤„ç†å®Œæˆï¼Œè§£é”è¿”å›</span></span><br><span class="line">        unlock(&amp;c.lock)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ°è¿™é‡Œè¯´æ˜chançš„bufé‡Œæ²¡æœ‰æ•°æ®äº†ï¼Œå¦‚æœæ˜¯éé˜»å¡æ¥æ”¶å°±ç›´æ¥è¿”å›äº†</span></span><br><span class="line">    <span class="keyword">if</span> !block &#123;</span><br><span class="line">        unlock(&amp;c.lock)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥ä¸‹æ¥å°±æ˜¯è¦è¢«é˜»å¡çš„æƒ…å†µäº†</span></span><br><span class="line">    <span class="comment">// å’Œå‘é€ç±»ä¼¼çš„ï¼Œæ„é€ ä¸€ä¸ª sudog</span></span><br><span class="line">    gp := getg()</span><br><span class="line">    mysg := acquireSudog()</span><br><span class="line">    mysg.releasetime = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> t0 != <span class="number">0</span> &#123;</span><br><span class="line">        mysg.releasetime = <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œepå°±æ˜¯æˆ‘ä»¬ç”¨æ¥æ¥æ”¶å€¼å¾—å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è¿™é‡ŒæŠŠepç›´æ¥å­˜åˆ°sudog.elemå­—æ®µä¸Š</span></span><br><span class="line">    mysg.elem = ep </span><br><span class="line">    mysg.waitlink = <span class="literal">nil</span></span><br><span class="line">    gp.waiting = mysg <span class="comment">// è¿™ä¸ªwaitingåŒæ ·æ˜¯ç”¨æ¥å”¤é†’ååšæ ¡éªŒçš„</span></span><br><span class="line">    mysg.g = gp</span><br><span class="line">    mysg.isSelect = <span class="literal">false</span></span><br><span class="line">    mysg.c = c</span><br><span class="line">    gp.param = <span class="literal">nil</span></span><br><span class="line">    <span class="comment">// åŠ å…¥åˆ°chançš„recvqé˜Ÿåˆ—é‡Œ</span></span><br><span class="line">    c.recvq.enqueue(mysg)</span><br><span class="line">    atomic.Store8(&amp;gp.parkingOnChan, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">// å°†å½“å‰ goroutine æŒ‚èµ·</span></span><br><span class="line">    gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanReceive, traceEvGoBlockRecv, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å”¤é†’åï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒæ ·æ˜¯è¿›è¡Œæ•°æ®æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">if</span> mysg != gp.waiting &#123;</span><br><span class="line">        throw(<span class="string">&quot;G waiting list is corrupted&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    gp.waiting = <span class="literal">nil</span></span><br><span class="line">    gp.activeStackChans = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> mysg.releasetime &gt; <span class="number">0</span> &#123;</span><br><span class="line">        blockevent(mysg.releasetime-t0, <span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆæ˜¯mysg.successï¼Œå¦‚æœchanæ´»åŠ¨è¿‡å°±æ˜¯trueï¼Œå¦åˆ™æ˜¯false</span></span><br><span class="line">    success := mysg.success</span><br><span class="line">    gp.param = <span class="literal">nil</span></span><br><span class="line">    mysg.c = <span class="literal">nil</span></span><br><span class="line">    releaseSudog(mysg)<span class="comment">// å°† sudog æ”¾å›å¯¹è±¡æ± </span></span><br><span class="line">    <span class="comment">// åˆ°è¿™é‡Œå¦‚æœgoroutineè¢«æ­£å¸¸å”¤é†’è‚¯å®šæ˜¯å¯ä»¥å–åˆ°æ•°æ®çš„</span></span><br><span class="line">    <span class="comment">// å› ä¸ºrecvqçš„æ•°æ®æ˜¯ç”±å‘é€çš„æ—¶å€™ç›´æ¥copyè¿‡æ¥äº†</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>, success</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­è¿½è¸ªä¸€ä¸‹ recv æ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf <span class="keyword">func</span>()</span>, <span class="title">skip</span> <span class="title">int</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// éç¼“å†²å‹çš„ channel</span></span><br><span class="line">    <span class="keyword">if</span> c.dataqsiz == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// å¹¶ä¸”éœ€è¦æ¥æ”¶å€¼</span></span><br><span class="line">        <span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// ç›´æ¥è¿›è¡Œå†…å­˜æ‹·è´</span></span><br><span class="line">            recvDirect(c.elemtype, sg, ep)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// éœ€è¦æ³¨æ„ï¼šè¿›å…¥recvæ–¹æ³•è¯´æ˜sendqé˜Ÿåˆ—é‡Œæ˜¯æœ‰å€¼çš„</span></span><br><span class="line">        <span class="comment">// é‚£ä¹ˆå¯¹ç¼“å†²å‹çš„ channelæ¥è¯´ï¼Œsendqæœ‰å€¼å°±æ„å‘³ç€bufæ»¡äº†</span></span><br><span class="line">        <span class="comment">// ä¹Ÿå°±æ˜¯ recvxå’Œsendxé‡åˆäº†éƒ½</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œè¦åšçš„å°±æ˜¯å…ˆä»bufä¸­è¯»ä¸€ä¸ªæ•°æ®å‡ºæ¥ï¼Œç„¶åå†æŠŠå‘é€è€…å‘é€çš„æ•°æ®å†™å…¥buf</span></span><br><span class="line">        qp := chanbuf(c, c.recvx)</span><br><span class="line">        <span class="comment">// å°†æ¥æ”¶æ¸¸æ ‡å¤„çš„æ•°æ®æ‹·è´ç»™æ¥æ”¶è€…</span></span><br><span class="line">        <span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</span><br><span class="line">            typedmemmove(c.elemtype, ep, qp)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä»å‘é€è€…æŠŠæ•°æ®å†™å…¥ recvx</span></span><br><span class="line">        typedmemmove(c.elemtype, qp, sg.elem)</span><br><span class="line">        <span class="comment">// ç„¶åä¿®æ”¹ recvxå’Œsendx çš„ä½ç½®</span></span><br><span class="line">        c.recvx++</span><br><span class="line">        <span class="keyword">if</span> c.recvx == c.dataqsiz &#123;</span><br><span class="line">            c.recvx = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        c.sendx = c.recvx <span class="comment">// c.sendx = (c.sendx+1) % c.dataqsiz</span></span><br><span class="line">    &#125;</span><br><span class="line">    sg.elem = <span class="literal">nil</span></span><br><span class="line">    gp := sg.g</span><br><span class="line">    <span class="comment">// è§£é”</span></span><br><span class="line">    unlockf()</span><br><span class="line">    gp.param = unsafe.Pointer(sg)</span><br><span class="line">    sg.success = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> sg.releasetime != <span class="number">0</span> &#123;</span><br><span class="line">        sg.releasetime = cputicks()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æœ€åå”¤é†’å‘é€çš„ goroutine</span></span><br><span class="line">    goready(gp, skip+<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†çœ‹ä¸€ä¸‹ recvDirectï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recvDirect</span><span class="params">(t *_type, sg *sudog, dst unsafe.Pointer)</span></span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯éç¼“å†²å‹çš„ï¼Œå°±ç›´æ¥ä»å‘é€è€…çš„æ ˆæ‹·è´åˆ°æ¥æ”¶è€…çš„æ ˆã€‚</span></span><br><span class="line">    <span class="comment">// å’ŒsendDirectä¸€æ ·çš„éœ€è¦åŠ å†…å­˜å±éšœ</span></span><br><span class="line">    src := sg.elem</span><br><span class="line">    typeBitsBulkBarrier(t, <span class="keyword">uintptr</span>(dst), <span class="keyword">uintptr</span>(src), t.size)</span><br><span class="line">    memmove(dst, src, t.size)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹äº†æ¥æ”¶éƒ¨åˆ†ä»£ç åï¼Œæ•´ä¸ªæµç¨‹å°±æ›´æ–°æ¸…æ™°äº†ã€‚</p>
<p>æ ¹æ®å‰é¢çš„å‘é€é€»è¾‘å¯ä»¥çŸ¥é“ï¼Œä¸ç®¡æ˜¯æ¥æ”¶è¿˜æ˜¯å‘é€åªè¦è¢«é˜»å¡äº†ï¼ŒåŠ å…¥åˆ°äº† sendq æˆ–è€… recvq ä¹‹åï¼Œé‚£ä¹ˆåç»­çš„å‘é€æˆ–è€…æ¥æ”¶éƒ½æ˜¯ç”±å¯¹æ–¹è¿›è¡Œå¤„ç†äº†ã€‚</p>
<p>æ¯”å¦‚æ¥æ”¶è¢«é˜»å¡äº†ï¼Œå½“å‰ g æ„æˆæˆä¸€ä¸ª sudog ç„¶ååŠ å…¥åˆ° recvqï¼Œæ¥ç€è°ƒç”¨äº† gopark å°±å·²ç»é˜»å¡äº†ï¼Œå•¥ä¹Ÿå¹²ä¸äº†äº†ã€‚</p>
<p>åªèƒ½ç­‰åˆ°æœ‰å‘é€è€…æ¥çš„æ—¶å€™ç›´æ¥ä» recvq é‡ŒæŠŠè¿™ä¸ª sudog å–å‡ºæ¥ï¼Œå¹¶ä¸”ç›´æ¥æŠŠè¦ä»–å‘é€çš„å€¼æ‹·è´åˆ°è¿™ä¸ª sudog.elem å­—æ®µä¸Šï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ chan æ¥æ”¶æ–¹æ³•æ˜¯ä¼ è¿›æ¥çš„å“ªä¸ªå€¼. æœ€åå‘é€æ–¹å†è°ƒç”¨ goready æŠŠè¿™ä¸ª g ç»™å”¤é†’ï¼Œè¿™æ ·å†æŠŠå‰©ä¸‹çš„é€»è¾‘èµ°å®Œï¼Œè¿™ä¸ªè¢«é˜»å¡äº†ä¸€ä¼šçš„æ¥æ”¶è€…å°±å¯ä»¥æ‹¿ç€æ•°æ®è¿”å›äº†ã€‚</p>
<p>æ ¸å¿ƒé€»è¾‘ï¼š</p>
<ul>
<li>1ï¼‰å¦‚æœæœ‰ç­‰å¾…å‘é€æ•°æ®çš„ groutineï¼Œä» sendq ä¸­å–å‡ºä¸€ä¸ªç­‰å¾…å‘é€æ•°æ®çš„ Groutineï¼Œå–å‡ºæ•°æ®</li>
<li>2ï¼‰å¦‚æœæ²¡æœ‰ç­‰å¾…çš„ groutineï¼Œä¸”ç¯å½¢é˜Ÿåˆ—ä¸­æœ‰æ•°æ®ï¼Œä»é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®</li>
<li>3ï¼‰å¦‚æœæ²¡æœ‰ç­‰å¾…çš„ groutineï¼Œä¸”ç¯å½¢é˜Ÿåˆ—ä¸­ä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œåˆ™é˜»å¡è¯¥ Groutineï¼Œå¹¶å°† groutine æ‰“åŒ…ä¸º sudogo åŠ å…¥åˆ° recevq ç­‰å¾…é˜Ÿåˆ—ä¸­</li>
</ul>
<h3 id="3-4-å…³é—­-chan"><a href="#3-4-å…³é—­-chan" class="headerlink" title="3.4 å…³é—­ chan"></a>3.4 å…³é—­ chan</h3><p>close å°±æ¯”è¾ƒç®€å•äº†ï¼Œç›¸å…³æ–¹æ³•å°±ä¸¤ä¸ªï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:linkname reflect_chanclose</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reflect_chanclose</span><span class="params">(c *hchan)</span></span> &#123;</span><br><span class="line">    closechan(c)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">closechan</span><span class="params">(c *hchan)</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ä¸€ä¸ªè¿˜æ˜¯åŒ…è£…æ–¹æ³•ï¼ŒçœŸæ­£é€»è¾‘å°±åœ¨ clsoechan é‡Œã€‚</p>
<blockquote>
<p>æ¯ä¸ªé€»è¾‘éƒ½æœ‰ä¸€ä¸ª reflect_xxx çš„æ–¹æ³•ï¼Œæ ¹æ®åå­—çŒœæµ‹æ˜¯åå°„çš„æ—¶å€™ç”¨çš„ã€‚</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">closechan</span><span class="params">(c *hchan)</span></span> &#123;</span><br><span class="line">    <span class="comment">// å…³é—­ä¸€ä¸ªnilçš„chanç›´æ¥panic</span></span><br><span class="line">    <span class="keyword">if</span> c == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(plainError(<span class="string">&quot;close of nil channel&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŒæ ·æ˜¯å…ˆåŠ é”</span></span><br><span class="line">    lock(&amp;c.lock)</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦è¢«å…³é—­è¿‡äº†ï¼Œå…³é—­ä¸€ä¸ªå·²ç»å…³é—­çš„chanä¹Ÿæ˜¯ç›´æ¥panic</span></span><br><span class="line">    <span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">        unlock(&amp;c.lock)</span><br><span class="line">        <span class="built_in">panic</span>(plainError(<span class="string">&quot;close of closed channel&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¿®æ”¹closedæ ‡è®°ä¸ºï¼Œè¡¨ç¤ºchanå·²ç»è¢«å…³é—­äº†</span></span><br><span class="line">    c.closed = <span class="number">1</span></span><br><span class="line">    <span class="comment">// gList æ˜¯é€šè¿‡ g.schedlink é“¾æ¥ G çš„åˆ—è¡¨ï¼Œä¸€ä¸ª G åªèƒ½æ˜¯ä¸€æ¬¡åœ¨ä¸€ä¸ª gQueue æˆ– gList ä¸Š</span></span><br><span class="line">    <span class="comment">// gList æ¨¡æ‹Ÿçš„æ˜¯æ ˆæ“ä½œï¼ˆFILOï¼‰</span></span><br><span class="line">    <span class="comment">// gQueue æ¨¡æ‹Ÿçš„æ˜¯é˜Ÿåˆ—æ“ä½œï¼ˆFIFOï¼‰</span></span><br><span class="line">    <span class="keyword">var</span> glist gList</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾æ‰€æœ‰çš„æ¥æ”¶è€…</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        sg := c.recvq.dequeue()</span><br><span class="line">        <span class="comment">// sg == nilï¼Œè¡¨ç¤ºæ¥æ”¶é˜Ÿåˆ—å·²ä¸ºç©ºï¼Œè·³å‡ºå¾ªç¯</span></span><br><span class="line">        <span class="keyword">if</span> sg == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœ elem ä¸ä¸ºç©ºè¯´æ˜æœªå¿½ç•¥æ¥æ”¶å€¼ï¼Œèµ‹å€¼ä¸ºè¯¥ç±»å‹çš„é›¶å€¼</span></span><br><span class="line">        <span class="keyword">if</span> sg.elem != <span class="literal">nil</span> &#123;</span><br><span class="line">            typedmemclr(c.elemtype, sg.elem)</span><br><span class="line">            sg.elem = <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> sg.releasetime != <span class="number">0</span> &#123;</span><br><span class="line">            sg.releasetime = cputicks()</span><br><span class="line">        &#125;</span><br><span class="line">        gp := sg.g</span><br><span class="line">        gp.param = unsafe.Pointer(sg)</span><br><span class="line">        sg.success = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">            raceacquireg(gp, c.raceaddr())</span><br><span class="line">        &#125;</span><br><span class="line">        glist.push(gp)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// release all writers (they will panic)</span></span><br><span class="line">    <span class="comment">// é‡Šæ”¾æ‰€æœ‰çš„å‘é€è€…ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        sg := c.sendq.dequeue()</span><br><span class="line">        <span class="keyword">if</span> sg == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        sg.elem = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">if</span> sg.releasetime != <span class="number">0</span> &#123;</span><br><span class="line">            sg.releasetime = cputicks()</span><br><span class="line">        &#125;</span><br><span class="line">        gp := sg.g</span><br><span class="line">        gp.param = unsafe.Pointer(sg)</span><br><span class="line">        sg.success = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">            raceacquireg(gp, c.raceaddr())</span><br><span class="line">        &#125;</span><br><span class="line">        glist.push(gp)</span><br><span class="line">    &#125;</span><br><span class="line">    unlock(&amp;c.lock)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾ªç¯è¯»å– glist é‡Œé¢çš„æ•°æ®ï¼ŒæŒ¨ä¸ªå”¤é†’</span></span><br><span class="line">    <span class="keyword">for</span> !glist.empty() &#123;</span><br><span class="line">        gp := glist.pop()</span><br><span class="line">        gp.schedlink = <span class="number">0</span></span><br><span class="line">        goready(gp, <span class="number">3</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¸å¿ƒæµç¨‹ï¼š</p>
<ul>
<li>è®¾ç½®å…³é—­çŠ¶æ€</li>
<li>å”¤é†’æ‰€æœ‰ç­‰å¾…è¯»å– chanel çš„åç¨‹</li>
<li>æ‰€æœ‰ç­‰å¾…å†™å…¥ channel çš„åç¨‹ï¼ŒæŠ›å‡ºå¼‚å¸¸</li>
</ul>
<h2 id="4-è¿›é˜¶"><a href="#4-è¿›é˜¶" class="headerlink" title="4. è¿›é˜¶"></a>4. è¿›é˜¶</h2><h3 id="4-1-æ“ä½œ-chan"><a href="#4-1-æ“ä½œ-chan" class="headerlink" title="4.1 æ“ä½œ chan"></a>4.1 æ“ä½œ chan</h3><p>æ€»ç»“ä¸€ä¸‹æ“ä½œ channel çš„ç»“æœï¼š</p>
<table>
<thead>
<tr>
<th>æ“ä½œ</th>
<th>nil channel</th>
<th>closed channel</th>
<th>not nil, not closed channel</th>
</tr>
</thead>
<tbody><tr>
<td>close</td>
<td>panic</td>
<td>panic</td>
<td>æ­£å¸¸å…³é—­</td>
</tr>
<tr>
<td>è¯» &lt;- ch</td>
<td>é˜»å¡</td>
<td>è¯»åˆ°å¯¹åº”ç±»å‹çš„é›¶å€¼</td>
<td>é˜»å¡æˆ–æ­£å¸¸è¯»å–æ•°æ®ã€‚ç¼“å†²å‹ channel ä¸ºç©ºæˆ–éç¼“å†²å‹ channel æ²¡æœ‰ç­‰å¾…å‘é€è€…æ—¶ä¼šé˜»å¡</td>
</tr>
<tr>
<td>å†™ ch &lt;-</td>
<td>é˜»å¡</td>
<td>panic</td>
<td>é˜»å¡æˆ–æ­£å¸¸å†™å…¥æ•°æ®ã€‚éç¼“å†²å‹ channel æ²¡æœ‰ç­‰å¾…æ¥æ”¶è€…æˆ–ç¼“å†²å‹ channel buf æ»¡æ—¶ä¼šè¢«é˜»å¡</td>
</tr>
</tbody></table>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œå‘ç”Ÿ panic çš„æƒ…å†µæœ‰ä¸‰ç§ï¼šå‘ä¸€ä¸ªå…³é—­çš„ channel è¿›è¡Œå†™æ“ä½œï¼›å…³é—­ä¸€ä¸ª nil çš„ channelï¼›é‡å¤å…³é—­ä¸€ä¸ª channelã€‚</p>
<p>è¯»ã€å†™ä¸€ä¸ª nil channel éƒ½ä¼šè¢«é˜»å¡ã€‚</p>
<h3 id="4-2-å‘é€å’Œæ¥æ”¶å…ƒç´ çš„æœ¬è´¨"><a href="#4-2-å‘é€å’Œæ¥æ”¶å…ƒç´ çš„æœ¬è´¨" class="headerlink" title="4.2 å‘é€å’Œæ¥æ”¶å…ƒç´ çš„æœ¬è´¨"></a>4.2 å‘é€å’Œæ¥æ”¶å…ƒç´ çš„æœ¬è´¨</h3><p>Channel å‘é€å’Œæ¥æ”¶å…ƒç´ çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿå‚è€ƒèµ„æ–™ã€æ·±å…¥ channel åº•å±‚ã€‘é‡Œæ˜¯è¿™æ ·å›ç­”çš„ï¼š</p>
<blockquote>
<p>Remember all transfer of value on the go channels happens with the copy of value.</p>
</blockquote>
<p>å°±æ˜¯è¯´ channel çš„å‘é€å’Œæ¥æ”¶æ“ä½œæœ¬è´¨ä¸Šéƒ½æ˜¯ â€œå€¼çš„æ‹·è´â€ï¼Œæ— è®ºæ˜¯ä» sender goroutine çš„æ ˆåˆ° chan bufï¼Œè¿˜æ˜¯ä» chan buf åˆ° receiver goroutineï¼Œæˆ–è€…æ˜¯ç›´æ¥ä» sender goroutine åˆ° receiver goroutineã€‚</p>
<p>è¿™é‡Œå†å¼•ç”¨æ–‡ä¸­çš„ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä¼šåŠ ä¸Šæ›´åŠ è¯¦ç»†åœ°è§£é‡Šã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="keyword">string</span></span><br><span class="line">    age <span class="keyword">int8</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> u = user&#123;name: <span class="string">&quot;Ankur&quot;</span>, age: <span class="number">25</span>&#125;</span><br><span class="line"><span class="keyword">var</span> g = &amp;u</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">modifyUser</span><span class="params">(pu *user)</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;modifyUser Received Vaule&quot;</span>, pu)</span><br><span class="line">    pu.name = <span class="string">&quot;Anand&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printUser</span><span class="params">(u &lt;-<span class="keyword">chan</span> *user)</span></span> &#123;</span><br><span class="line">    time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">    fmt.Println(<span class="string">&quot;printUser goRoutine called&quot;</span>, &lt;-u)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> *user, <span class="number">5</span>)</span><br><span class="line">    c &lt;- g</span><br><span class="line">    fmt.Println(g)</span><br><span class="line">    <span class="comment">// modify g</span></span><br><span class="line">    g = &amp;user&#123;name: <span class="string">&quot;Ankur Anand&quot;</span>, age: <span class="number">100</span>&#125;</span><br><span class="line">    <span class="keyword">go</span> printUser(c)</span><br><span class="line">    <span class="keyword">go</span> modifyUser(g)</span><br><span class="line">    time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">    fmt.Println(g)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&amp;&#123;Ankur <span class="number">25</span>&#125;</span><br><span class="line">modifyUser Received Value &amp;&#123;Ankur Anand <span class="number">100</span>&#125;</span><br><span class="line">printUser goRoutine called &amp;&#123;Ankur <span class="number">25</span>&#125;</span><br><span class="line">&amp;&#123;Anand <span class="number">100</span>&#125;</span><br></pre></td></tr></table></figure>

<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/gaoyanliang/cdn@main/blog/img/post/go/go4.png" fancybox="true"/></div></div>

<p>ä¸€å¼€å§‹æ„é€ ä¸€ä¸ªç»“æ„ä½“ uï¼Œåœ°å€æ˜¯ 0x56420ï¼Œå›¾ä¸­åœ°å€ä¸Šæ–¹å°±æ˜¯å®ƒçš„å†…å®¹ã€‚æ¥ç€æŠŠ &amp;u èµ‹å€¼ç»™æŒ‡é’ˆ gï¼Œg çš„åœ°å€æ˜¯ 0x565bb0ï¼Œå®ƒçš„å†…å®¹å°±æ˜¯ä¸€ä¸ªåœ°å€ï¼ŒæŒ‡å‘ uã€‚</p>
<p>main ç¨‹åºé‡Œï¼Œå…ˆæŠŠ g å‘é€åˆ° cï¼Œæ ¹æ® copy value çš„æœ¬è´¨ï¼Œè¿›å…¥åˆ° chan buf é‡Œçš„å°±æ˜¯ 0x56420ï¼Œå®ƒæ˜¯æŒ‡é’ˆ g çš„å€¼ï¼ˆä¸æ˜¯å®ƒæŒ‡å‘çš„å†…å®¹ï¼‰ï¼Œæ‰€ä»¥æ‰“å°ä» channel æ¥æ”¶åˆ°çš„å…ƒç´ æ—¶ï¼Œå®ƒå°±æ˜¯ &amp;{Ankur 25}ã€‚å› æ­¤ï¼Œè¿™é‡Œå¹¶ä¸æ˜¯å°†æŒ‡é’ˆ g â€œå‘é€â€ åˆ°äº† channel é‡Œï¼Œåªæ˜¯æ‹·è´å®ƒçš„å€¼è€Œå·²ã€‚</p>
<h3 id="4-3-èµ„æºæ³„æ¼"><a href="#4-3-èµ„æºæ³„æ¼" class="headerlink" title="4.3 èµ„æºæ³„æ¼"></a>4.3 èµ„æºæ³„æ¼</h3><p>Channel å¯èƒ½ä¼šå¼•å‘ goroutine æ³„æ¼ã€‚</p>
<p>æ³„æ¼çš„åŸå› æ˜¯ goroutine æ“ä½œ channel åï¼Œå¤„äºå‘é€æˆ–æ¥æ”¶é˜»å¡çŠ¶æ€ï¼Œè€Œ channel å¤„äºæ»¡æˆ–ç©ºçš„çŠ¶æ€ï¼Œä¸€ç›´å¾—ä¸åˆ°æ”¹å˜ã€‚åŒæ—¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¹Ÿä¸ä¼šå›æ”¶æ­¤ç±»èµ„æºï¼Œè¿›è€Œå¯¼è‡´ gouroutine ä¼šä¸€ç›´å¤„äºç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œä¸è§å¤©æ—¥ã€‚</p>


<div class="article-footer reveal fs14"><section id="references"><div class="header"><span>References</span></div><div class="body"><ul><li class="post-title"><a href="https://www.lixueduan.com/posts/go/chan/" target="_blank" rel="external nofollow noopener noreferrer">Goè¯­è¨€ä¹‹ chan æºç åˆ†æ</a></li><li class="post-title"><a href="https://juejin.cn/post/6875325172249788429#heading-18" target="_blank" rel="external nofollow noopener noreferrer">å›¾è§£Golang channelæºç </a></li></ul></div></section><section id="license"><div class="header"><span>License</span></div><div class="body"><p>æœ¬æ–‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div></section></div>

</article>

<div class="related-wrap reveal" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">Newer</div><a href="/go/context/">Go ç³»åˆ—(äºŒ)ï¼šcontext æºç åˆ†æ</a></div><div class="item" id="next"><div class="note">Older</div><a href="/docker/docker_core/">Docker ç³»åˆ—(ä¸‰)ï¼šDocker æ ¸å¿ƒåŸç†</a></div></section></div>






  <div class='related-wrap md-text reveal' id="comments">
    <section class='header cmt-title cap theme'>
      Join the discussion
    </section>
    <section class='body cmt-body beaudar'>
      

<svg class="loading" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="beaudar" repo="gaoyanliang/beaudar" issue-term="pathname" theme="preferred-color-scheme" input-position="top" comment-order="desc" loading="false" branch="main"></div>

    </section>
  </div>



      
<footer class="page-footer reveal fs12"><hr><div class="sitemap"><div class="sitemap-group"><span class="fs14">Blog</span><a href="/">Recent Update</a><a href="/blog/categories/">Categories</a><a href="/blog/tags/">Tags</a><a href="/blog/archives/">Archives</a></div><div class="sitemap-group"><span class="fs14">Wiki</span><a href="/wiki/tags/%E6%8A%80%E6%9C%AF%E5%8A%A0%E6%B2%B9%E7%AB%99/">æŠ€æœ¯åŠ æ²¹ç«™</a><a href="/wiki/">...</a></div><div class="sitemap-group"><span class="fs14">Social</span><a href="/friends/">Friends</a><a href="/about/#comments">Comments</a><a target="_blank" rel="noopener" href="https://open.spotify.com/">Spotify</a></div><div class="sitemap-group"><span class="fs14">More</span><a href="/about/">About</a><a href="/wiki/resume">Resume</a><a target="_blank" rel="noopener" href="https://github.com/gyl-coder">GitHub</a></div></div><div class="text"><p>æœ¬ç«™ç”± <a href="/">@yanliang</a> ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> ä¸»é¢˜åˆ›å»ºã€‚<br>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div></footer>

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    <script type="text/javascript">
  const stellar = {
    // æ‡’åŠ è½½ css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // ä» butterfly å’Œ volantis è·å¾—çµæ„Ÿ
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // é»˜è®¤å¼‚æ­¥ï¼Œå¦‚æœéœ€è¦åŒæ­¥ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ {} å³å¯
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.version = '1.18.4';
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.18.4';
  stellar.config = {
    date_suffix: {
      just: 'Just',
      min: 'minutes ago',
      hour: 'hours ago',
      day: 'days ago',
      month: 'months ago',
    },
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://gcore.jsdelivr.net/npm/jquery@3.6.2/dist/jquery.min.js'
  };

  if ('local_search') {
    stellar.search = {};
    stellar.search.service = 'local_search';
    if (stellar.search.service == 'local_search') {
      let service_obj = Object.assign({}, {"field":"all","path":"/search.json","content":true,"sort":"-date"});
      stellar.search[stellar.search.service] = service_obj;
    }
  }

  // stellar js
  stellar.plugins.stellar = Object.assign({"sites":"/js/plugins/sites.js","friends":"/js/plugins/friends.js","ghinfo":"/js/plugins/ghinfo.js","timeline":"/js/plugins/timeline.js","linkcard":"/js/plugins/linkcard.js","fcircle":"/js/plugins/fcircle.js","weibo":"/js/plugins/weibo.js"});
  stellar.plugins.marked = Object.assign("https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js");

  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.css","js":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.js"});
  }
  
  // -------- start è‡ªå®šä¹‰é¦–é¡µæ–‡ç« è½®æ’­
  if ('true' == 'true') {
    stellar.plugins.customSwiperTopArticle = Object.assign({"enable":true,"css":"https://cdn.jsdelivr.net/gh/XuxuGood/simple-blog-cdn@main/css/swiper/swiper.min.css","js":"https://cdn.jsdelivr.net/gh/XuxuGood/simple-blog-cdn@main/js/swiper/swiper.min.js","init_js":"https://cdn.jsdelivr.net/gh/XuxuGood/simple-blog-cdn@main/js/swiper/swiper_init.js"});
  }
  // -------- end è‡ªå®šä¹‰é¦–é¡µæ–‡ç« è½®æ’­

  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://gcore.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://gcore.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.fancybox = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js","css":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css","selector":".swiper-slide img"});
  }
  if ('false' == 'true') {
    stellar.plugins.heti = Object.assign({"enable":false,"css":"https://unpkg.com/heti@0.9.2/umd/heti.min.css","js":"https://unpkg.com/heti@0.9.2/umd/heti-addon.min.js"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->

  <script>
  function loadBeaudar() {
    const els = document.querySelectorAll("#comments #beaudar");
    if (els.length === 0) return;
    els.forEach((el, i) => {
      try {
        el.innerHTML = '';
      } catch (error) {
        console.log(error);
      }
      var script = document.createElement('script');
      script.src = 'https://beaudar.lipk.org/client.js';
      script.async = true;
      for (let key of Object.keys(el.attributes)) {
        let attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
    });
  }
  window.addEventListener('DOMContentLoaded', (event) => {
      loadBeaudar();
  });
</script>




<!-- inject -->


  </div>
</body>
</html>
